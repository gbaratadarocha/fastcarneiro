<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA / iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FastCarneiro">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <!-- App Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üêë</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üêë</text></svg>">
    
    <title>FastCarneiro - Jejum Intermitente em Fam√≠lia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/custom.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .badge-glow {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
    
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl card-shadow max-w-md w-full p-8 fade-in">
            <div class="text-center mb-8">
                <div class="inline-block gradient-bg p-4 rounded-full mb-4">
                    <i class="fas fa-utensils text-white text-4xl"></i>
                </div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">FastCarneiro</h1>
                <p class="text-gray-600 text-lg">Jejum Intermitente em Fam√≠lia</p>
                <p class="text-purple-600 font-semibold mt-2">üêë Bem-vindo √† Tribo!</p>
            </div>

            <!-- Sele√ß√£o de Membro -->
            <div id="memberSelection" class="space-y-4">
                <p class="text-center text-gray-700 font-semibold mb-4">Quem √© voc√™?</p>
                
                <button onclick="selectMember('user1')" class="member-btn w-full bg-white border-2 border-gray-300 rounded-xl py-4 px-6 flex items-center space-x-4 hover:border-purple-500 transition-all duration-300 hover:shadow-lg">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        üêë
                    </div>
                    <div class="text-left flex-1">
                        <div class="font-bold text-gray-800">Gon√ßalo</div>
                        <div class="text-sm text-gray-500">Carneiro Normal</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </button>

                <button onclick="selectMember('user2')" class="member-btn w-full bg-white border-2 border-gray-300 rounded-xl py-4 px-6 flex items-center space-x-4 hover:border-purple-500 transition-all duration-300 hover:shadow-lg">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);">
                        üôè
                    </div>
                    <div class="text-left flex-1">
                        <div class="font-bold text-gray-800">Joana</div>
                        <div class="text-sm text-gray-500">Esposa Beata</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </button>

                <button onclick="selectMember('user3')" class="member-btn w-full bg-white border-2 border-gray-300 rounded-xl py-4 px-6 flex items-center space-x-4 hover:border-purple-500 transition-all duration-300 hover:shadow-lg">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                        üéØ
                    </div>
                    <div class="text-left flex-1">
                        <div class="font-bold text-gray-800">Joana</div>
                        <div class="text-sm text-gray-500">Irm√£ Deficit</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </button>

                <button onclick="selectMember('user4')" class="member-btn w-full bg-white border-2 border-gray-300 rounded-xl py-4 px-6 flex items-center space-x-4 hover:border-purple-500 transition-all duration-300 hover:shadow-lg">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        üí®
                    </div>
                    <div class="text-left flex-1">
                        <div class="font-bold text-gray-800">Ci</div>
                        <div class="text-sm text-gray-500">Cunhado Peidolas</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </button>
            </div>

            <!-- Tela de Senha (Oculta inicialmente) -->
            <div id="passwordScreen" class="hidden space-y-4">
                <button onclick="backToMemberSelection()" class="text-gray-600 hover:text-gray-800 flex items-center space-x-2 mb-4">
                    <i class="fas fa-arrow-left"></i>
                    <span>Voltar</span>
                </button>

                <div class="text-center mb-6">
                    <div id="selectedMemberAvatar" class="w-20 h-20 rounded-full mx-auto mb-3 flex items-center justify-center text-4xl"></div>
                    <div id="selectedMemberName" class="font-bold text-xl text-gray-800"></div>
                    <div id="selectedMemberTitle" class="text-sm text-gray-500"></div>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Digite seu c√≥digo:</label>
                    <input 
                        type="password" 
                        id="passwordInput" 
                        maxlength="4"
                        pattern="[0-9]*"
                        inputmode="numeric"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-center text-2xl font-bold tracking-widest focus:border-purple-500 focus:outline-none transition-all"
                        onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                        onkeyup="if(event.key === 'Enter') loginWithPassword()"
                    >
                </div>

                <button onclick="loginWithPassword()" class="w-full btn-primary text-white rounded-xl py-4 px-6 font-bold text-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                </button>

                <div id="errorMessage" class="hidden text-red-500 text-center text-sm font-semibold bg-red-50 py-2 px-4 rounded-lg">
                    ‚ùå C√≥digo incorreto! Tenta de novo.
                </div>

                <div class="text-center text-xs text-gray-500 mt-4">
                    <p>üí° Dica: C√≥digo padr√£o √© 4 d√≠gitos</p>
                </div>
            </div>

            <div class="mt-8 text-center text-sm text-gray-500">
                <p>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Fam√≠lia Barata da Rocha Falc√£o Carneiro</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                            <i class="fas fa-utensils text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">FastCarneiro</h1>
                            <p class="text-sm text-purple-100" id="userGreeting">Ol√°, Carneiro! üêë</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg px-4 py-2 transition-all">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white shadow-md sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-2">
                <div class="flex overflow-x-auto scrollbar-hide">
                    <button onclick="showTab('schedules')" class="tab-button tab-active flex-shrink-0 px-4 py-4 text-sm font-semibold rounded-t-lg transition-all" data-tab="schedules">
                        <i class="fas fa-clock mr-2"></i><span class="hidden sm:inline">Hor√°rios</span>
                    </button>
                    <button onclick="showTab('diary')" class="tab-button flex-shrink-0 px-4 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-t-lg transition-all" data-tab="diary">
                        <i class="fas fa-calendar-check mr-2"></i><span class="hidden sm:inline">Di√°rio</span>
                    </button>
                    <button onclick="showTab('rankings')" class="tab-button flex-shrink-0 px-4 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-t-lg transition-all" data-tab="rankings">
                        <i class="fas fa-trophy mr-2"></i><span class="hidden sm:inline">Rankings</span>
                    </button>
                    <button onclick="showTab('treasure')" class="tab-button flex-shrink-0 px-4 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-t-lg transition-all" data-tab="treasure">
                        <i class="fas fa-piggy-bank mr-2"></i><span class="hidden sm:inline">Tesouro</span>
                    </button>
                    <button onclick="showTab('chat')" class="tab-button flex-shrink-0 px-4 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-t-lg transition-all" data-tab="chat">
                        <i class="fas fa-comments mr-2"></i><span class="hidden sm:inline">Chat</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            
            <!-- Tab: Hor√°rios da Tribo -->
            <div id="schedulesTab" class="tab-content fade-in">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">üïê Hor√°rios da Tribo</h2>
                    <p class="text-gray-600">Veja quem est√° jejuando agora</p>
                </div>

                <!-- Current Status Card -->
                <div class="glass-effect rounded-2xl p-6 card-shadow mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Status Atual</h3>
                        <div id="currentTime" class="text-2xl font-bold text-purple-600"></div>
                    </div>
                    <div id="currentStatusList" class="space-y-3">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Family Schedule Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="familySchedules">
                    <!-- Populated by JS -->
                </div>

                <!-- Configure Schedule Button -->
                <div class="mt-6 text-center">
                    <button onclick="openScheduleModal()" class="btn-primary text-white px-8 py-4 rounded-xl font-semibold text-lg">
                        <i class="fas fa-cog mr-2"></i>Configurar Meu Jejum
                    </button>
                </div>
            </div>

            <!-- Tab: Meu Di√°rio -->
            <div id="diaryTab" class="tab-content hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">‚úÖ Meu Di√°rio Carneiro</h2>
                    <p class="text-gray-600">Registre seu progresso di√°rio</p>
                </div>

                <!-- Today's Check-in -->
                <div class="glass-effect rounded-2xl p-6 card-shadow mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Check-in de Hoje</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-purple-50 rounded-xl">
                            <div>
                                <p class="font-semibold text-gray-800">Consegui fazer o jejum?</p>
                                <p class="text-sm text-gray-600" id="todayDate"></p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="checkIn('yes')" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                                    <i class="fas fa-check mr-2"></i>Sim
                                </button>
                                <button onclick="checkIn('no')" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                                    <i class="fas fa-times mr-2"></i>N√£o
                                </button>
                            </div>
                        </div>

                        <!-- Weight Tracking -->
                        <div class="p-4 bg-blue-50 rounded-xl">
                            <p class="font-semibold text-gray-800 mb-3">Registrar Peso (opcional)</p>
                            <div class="flex space-x-2">
                                <input type="number" id="weightInput" placeholder="Ex: 75.5" class="flex-1 px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-purple-500 focus:outline-none" step="0.1">
                                <button onclick="saveWeight()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">
                                    <i class="fas fa-save"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Streak & Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="glass-effect rounded-xl p-6 text-center card-shadow">
                        <div class="text-4xl mb-2">üî•</div>
                        <div class="text-3xl font-bold text-purple-600" id="streakDays">0</div>
                        <div class="text-gray-600 font-semibold">Dias Seguidos</div>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center card-shadow">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        <div class="text-3xl font-bold text-green-600" id="successDays">0</div>
                        <div class="text-gray-600 font-semibold">Jejuns Completos</div>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center card-shadow">
                        <div class="text-4xl mb-2">üìä</div>
                        <div class="text-3xl font-bold text-blue-600" id="successRate">0%</div>
                        <div class="text-gray-600 font-semibold">Taxa de Sucesso</div>
                    </div>
                </div>

                <!-- History -->
                <div class="glass-effect rounded-2xl p-6 card-shadow">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Hist√≥rico Recente</h3>
                    <div id="historyList" class="space-y-2">
                        <!-- Populated by JS -->
                    </div>
                    
                    <!-- Delete History Button -->
                    <div class="mt-6 pt-4 border-t-2 border-gray-200">
                        <button onclick="deleteMyHistory()" class="w-full bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold transition-all flex items-center justify-center">
                            <i class="fas fa-trash-alt mr-2"></i>
                            üóëÔ∏è Apagar Meu Hist√≥rico Completo
                        </button>
                        <p class="text-xs text-gray-500 text-center mt-2">Esta a√ß√£o ir√° apagar todos os seus registros permanentemente</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Hall da Fama -->
            <div id="rankingsTab" class="tab-content hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">üèÜ Hall da Fama Familiar</h2>
                    <p class="text-gray-600">Rankings e conquistas da tribo</p>
                </div>

                <!-- Leaderboard -->
                <div class="glass-effect rounded-2xl p-6 card-shadow mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Classifica√ß√£o Geral</h3>
                    <div id="leaderboard" class="space-y-3">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Achievements -->
                <div class="glass-effect rounded-2xl p-6 card-shadow">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Conquistas Desbloqueadas</h3>
                    <div id="achievementsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Tab: Tesouro dos Carneiros -->
            <div id="treasureTab" class="tab-content hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">üí∞ Tesouro dos Carneiros Famintos</h2>
                    <p class="text-gray-600">Economizando para a viagem em fam√≠lia!</p>
                </div>

                <!-- Total Savings -->
                <div class="glass-effect rounded-2xl p-8 card-shadow mb-6 text-center">
                    <div class="text-6xl mb-4">üèÜ</div>
                    <div class="text-5xl font-bold text-purple-600 mb-2" id="totalSavings">0‚Ç¨</div>
                    <p class="text-gray-600 text-lg">Total Acumulado</p>
                </div>

                <!-- Individual Contributions -->
                <div class="glass-effect rounded-2xl p-6 card-shadow mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Contribui√ß√µes Individuais</h3>
                    <div id="individualSavings" class="space-y-3">
                        <!-- Populated by JS -->
                    </div>
                    
                    <!-- Delete My Savings Button -->
                    <div class="mt-6 pt-4 border-t-2 border-gray-200">
                        <button onclick="deleteMySavings()" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold transition-all flex items-center justify-center">
                            <i class="fas fa-ban mr-2"></i>
                            üí∏ Cancelar Minhas Economias
                        </button>
                        <p class="text-xs text-gray-500 text-center mt-2">Remove todas as suas contribui√ß√µes do tesouro (n√£o afeta os outros)</p>
                    </div>
                </div>

                <!-- Trip Calculator -->
                <div class="glass-effect rounded-2xl p-6 card-shadow">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Calculadora da Viagem</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Meta de Valor (‚Ç¨)</label>
                            <input type="number" id="tripGoal" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-purple-500 focus:outline-none" placeholder="Ex: 2000">
                        </div>
                        <button onclick="calculateTrip()" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">
                            <i class="fas fa-calculator mr-2"></i>Calcular
                        </button>
                        <div id="tripResult" class="hidden mt-4 p-4 bg-purple-50 rounded-xl">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Chat da Fam√≠lia -->
            <div id="chatTab" class="tab-content hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">üí¨ Chat da Fam√≠lia</h2>
                    <p class="text-gray-600">Apoio m√∫tuo e motiva√ß√£o</p>
                </div>

                <div class="glass-effect rounded-2xl p-6 card-shadow">
                    <!-- Chat Messages -->
                    <div id="chatMessages" class="h-96 overflow-y-auto mb-4 space-y-3 p-4 bg-gray-50 rounded-xl">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Chat Input -->
                    <div class="flex space-x-2">
                        <input type="text" id="chatInput" placeholder="Digite sua mensagem..." class="flex-1 px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-purple-500 focus:outline-none" onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>

                    <!-- Quick Reactions -->
                    <div class="mt-4 flex flex-wrap gap-2">
                        <button onclick="sendQuickMessage('üí™ For√ßa!')" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm transition-all">üí™ For√ßa!</button>
                        <button onclick="sendQuickMessage('üî• Arrasando!')" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm transition-all">üî• Arrasando!</button>
                        <button onclick="sendQuickMessage('üÜò Preciso de ajuda!')" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm transition-all">üÜò Preciso de ajuda!</button>
                        <button onclick="sendQuickMessage('üéâ Consegui!')" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm transition-all">üéâ Consegui!</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Schedule Configuration Modal -->
    <div id="scheduleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="glass-effect rounded-2xl max-w-md w-full p-6 card-shadow">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Configurar Jejum</h3>
                <button onclick="closeScheduleModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Tipo de Jejum</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectFastingType('14:10')" class="fasting-type-btn border-2 border-purple-500 bg-purple-50 text-purple-700 py-4 rounded-lg font-semibold transition-all" data-type="14:10">
                            14:10
                            <div class="text-xs mt-1">14h jejum</div>
                        </button>
                        <button onclick="selectFastingType('16:8')" class="fasting-type-btn border-2 border-gray-300 py-4 rounded-lg font-semibold transition-all hover:border-purple-500" data-type="16:8">
                            16:8
                            <div class="text-xs mt-1">16h jejum</div>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Hora de In√≠cio do Jejum</label>
                    <input type="time" id="fastingStart" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-purple-500 focus:outline-none" value="20:00">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Peso Atual (kg)</label>
                    <input type="number" id="currentWeight" placeholder="Ex: 75.5" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-purple-500 focus:outline-none" step="0.1">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Peso Objetivo (opcional)</label>
                    <input type="number" id="goalWeight" placeholder="Ex: 70.0" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-purple-500 focus:outline-none" step="0.1">
                </div>

                <div class="flex space-x-3 mt-6">
                    <button onclick="closeScheduleModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold transition-all">
                        Cancelar
                    </button>
                    <button onclick="saveSchedule()" class="flex-1 btn-primary text-white py-3 rounded-lg font-semibold">
                        Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts Inline para garantir funcionamento -->
    <script>
        // Vari√°veis globais
        window.currentUser = null;
        window.selectedUserId = null;
        
        // Configura√ß√£o do Google OAuth (mantido para compatibilidade)
        const GOOGLE_CLIENT_ID = '958880681956-ocq3sisa4uol7ctlbetot002hl5k9sr0.apps.googleusercontent.com';
        
        // Sistema de Login com Senha
        const FAMILY_MEMBERS_WITH_PASSWORDS = {
            'user1': {
                id: 'user1',
                name: 'Gon√ßalo',
                displayName: 'Carneiro Normal',
                emoji: 'üêë',
                password: '1234', // C√≥digo padr√£o (pode ser alterado)
                fasting_type: '16:8',
                fasting_start: '20:00',
                current_weight: 75,
                goal_weight: 70,
                avatar_color: '#667eea'
            },
            'user2': {
                id: 'user2',
                name: 'Joana',
                displayName: 'Esposa Beata',
                emoji: 'üôè',
                password: '2345',
                fasting_type: '14:10',
                fasting_start: '21:00',
                current_weight: 65,
                goal_weight: 60,
                avatar_color: '#f59e0b'
            },
            'user3': {
                id: 'user3',
                name: 'Joana',
                displayName: 'Irm√£ Deficit',
                emoji: 'üéØ',
                password: '3456',
                fasting_type: '16:8',
                fasting_start: '19:00',
                current_weight: 70,
                goal_weight: 65,
                avatar_color: '#ec4899'
            },
            'user4': {
                id: 'user4',
                name: 'Ci',
                displayName: 'Cunhado Peidolas',
                emoji: 'üí®',
                password: '4567',
                fasting_type: '14:10',
                fasting_start: '22:00',
                current_weight: 80,
                goal_weight: 75,
                avatar_color: '#10b981'
            }
        };
        
        // Fun√ß√£o para selecionar membro
        function selectMember(userId) {
            window.selectedUserId = userId;
            const member = FAMILY_MEMBERS_WITH_PASSWORDS[userId];
            
            // Esconder sele√ß√£o de membros
            document.getElementById('memberSelection').classList.add('hidden');
            
            // Mostrar tela de senha
            const passwordScreen = document.getElementById('passwordScreen');
            passwordScreen.classList.remove('hidden');
            
            // Preencher informa√ß√µes do membro selecionado
            const avatarDiv = document.getElementById('selectedMemberAvatar');
            avatarDiv.textContent = member.emoji;
            avatarDiv.style.background = `linear-gradient(135deg, ${member.avatar_color} 0%, ${adjustColor(member.avatar_color, -20)} 100%)`;
            
            document.getElementById('selectedMemberName').textContent = member.name;
            document.getElementById('selectedMemberTitle').textContent = member.displayName;
            
            // Focar no campo de senha
            setTimeout(() => {
                document.getElementById('passwordInput').focus();
            }, 300);
            
            // Limpar senha anterior e erro
            document.getElementById('passwordInput').value = '';
            document.getElementById('errorMessage').classList.add('hidden');
        }
        
        // Fun√ß√£o auxiliar para ajustar cor
        function adjustColor(color, amount) {
            return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
        }
        
        // Fun√ß√£o para voltar √† sele√ß√£o de membros
        function backToMemberSelection() {
            document.getElementById('passwordScreen').classList.add('hidden');
            document.getElementById('memberSelection').classList.remove('hidden');
            window.selectedUserId = null;
        }
        
        // Fun√ß√£o de login com senha
        function loginWithPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const enteredPassword = passwordInput.value.trim();
            const errorMessage = document.getElementById('errorMessage');
            
            // Validar entrada
            if (!enteredPassword || enteredPassword.length !== 4) {
                errorMessage.textContent = '‚ùå Por favor, digite um c√≥digo de 4 d√≠gitos!';
                errorMessage.classList.remove('hidden');
                passwordInput.classList.add('border-red-500');
                return;
            }
            
            // Verificar senha
            const member = FAMILY_MEMBERS_WITH_PASSWORDS[window.selectedUserId];
            
            if (enteredPassword === member.password) {
                // Senha correta! ‚úÖ
                console.log('Login bem-sucedido:', member.name);
                
                // Tentar carregar configura√ß√µes salvas do localStorage
                const savedSettings = localStorage.getItem('fastcarneiro_settings_' + member.id);
                let userSettings = {
                    fasting_type: member.fasting_type,
                    fasting_start: member.fasting_start,
                    current_weight: member.current_weight,
                    goal_weight: member.goal_weight
                };
                
                if (savedSettings) {
                    try {
                        const parsed = JSON.parse(savedSettings);
                        userSettings = {
                            fasting_type: parsed.fasting_type || member.fasting_type,
                            fasting_start: parsed.fasting_start || member.fasting_start,
                            current_weight: parsed.current_weight || member.current_weight,
                            goal_weight: parsed.goal_weight || member.goal_weight
                        };
                        console.log('‚úÖ Configura√ß√µes carregadas do localStorage:', userSettings);
                    } catch (e) {
                        console.error('Erro ao carregar configura√ß√µes salvas:', e);
                    }
                }
                
                // Criar usu√°rio com configura√ß√µes salvas
                const user = {
                    id: member.id,
                    name: member.name,
                    email: member.id + '@fastcarneiro.app',
                    fasting_type: userSettings.fasting_type,
                    fasting_start: userSettings.fasting_start,
                    current_weight: userSettings.current_weight,
                    goal_weight: userSettings.goal_weight,
                    avatar_color: member.avatar_color
                };
                
                // Salvar sess√£o
                window.currentUser = user;
                localStorage.setItem('fastcarneiro_user', JSON.stringify({
                    email: user.email,
                    id: user.id,
                    loginTime: new Date().toISOString()
                }));
                
                // Mostrar app
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userGreeting').textContent = `Ol√°, ${member.name}! ${member.emoji}`;
                
                // Inicializar app
                console.log('Iniciando app para:', member.name);
                console.log('currentUser definido:', window.currentUser);
                console.log('Tipo de initializeApp:', typeof initializeApp);
                
                setTimeout(() => {
                    try {
                        if (typeof initializeApp === 'function') {
                            console.log('Chamando initializeApp()...');
                            initializeApp();
                            console.log('initializeApp() executado com sucesso!');
                        } else if (typeof loadData === 'function') {
                            console.log('initializeApp n√£o existe, chamando loadData()...');
                            loadData();
                        } else {
                            console.error('ERRO: Nenhuma fun√ß√£o de inicializa√ß√£o encontrada!');
                        }
                        showToast('üéâ Bem-vindo!', `Ol√°, ${member.name}! Bom jejum!`, 'success');
                    } catch (error) {
                        console.error('ERRO ao inicializar app:', error);
                    }
                }, 500);
                
            } else {
                // Senha incorreta! ‚ùå
                errorMessage.textContent = '‚ùå C√≥digo incorreto! Tenta de novo.';
                errorMessage.classList.remove('hidden');
                passwordInput.classList.add('border-red-500');
                passwordInput.value = '';
                passwordInput.focus();
                
                // Remover borda vermelha ap√≥s 2 segundos
                setTimeout(() => {
                    passwordInput.classList.remove('border-red-500');
                }, 2000);
            }
        }
        
        // Emails autorizados da fam√≠lia (mantido para compatibilidade)
        const AUTHORIZED_EMAILS = [
            'gbaratadarocha@gmail.com',
            'joana.salgado.neves.sequeira@gmail.com',
            'joana.carneiro@thermosite.com',
            'pmirandasoares@gmail.com'
        ];
        
        // Mapeamento de emails para perfis
        const FAMILY_PROFILES = {
            'gbaratadarocha@gmail.com': {
                id: 'user1',
                name: 'Gon√ßalo',
                displayName: 'Carneiro Normal',
                fasting_type: '16:8',
                fasting_start: '20:00'
            },
            'joana.salgado.neves.sequeira@gmail.com': {
                id: 'user2',
                name: 'Joana',
                displayName: 'Esposa Beata',
                fasting_type: '14:10',
                fasting_start: '21:00'
            },
            'joana.carneiro@thermosite.com': {
                id: 'user3',
                name: 'Joana',
                displayName: 'Irm√£ Deficit',
                fasting_type: '16:8',
                fasting_start: '19:00'
            },
            'pmirandasoares@gmail.com': {
                id: 'user4',
                name: 'Ci',
                displayName: 'Cunhado Peidolas',
                fasting_type: '14:10',
                fasting_start: '22:00'
            }
        };
        
        // Fun√ß√£o de login com Google (REAL)
        function loginWithGoogle() {
            console.log('Login com Google clicado');
            
            // Verificar se est√° rodando localmente (file://)
            const isLocalFile = window.location.protocol === 'file:';
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' ||
                               window.location.hostname === '';
            
            if (isLocalFile || isLocalhost) {
                // Se for local, avisa e usa Demo
                const message = '‚ö†Ô∏è Login com Google n√£o funciona localmente!\n\n' +
                              'üìç Voc√™ est√° testando em: ' + window.location.protocol + '//' + window.location.host + '\n\n' +
                              '‚úÖ Para testar agora: Use o "Modo Demo"\n\n' +
                              'üöÄ Para usar Google OAuth:\n' +
                              '1. Publique a app online\n' +
                              '2. Configure o Google Cloud Console\n' +
                              '3. Teste no URL p√∫blico\n\n' +
                              'Vou te levar para o Modo Demo agora!';
                
                alert(message);
                enterDemoMode();
                return;
            }
            
            // Criar URL do Google OAuth
            const redirectUri = window.location.origin + window.location.pathname;
            const scope = 'email profile';
            const responseType = 'token id_token';
            const nonce = Math.random().toString(36).substring(7);
            
            const googleAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${GOOGLE_CLIENT_ID}` +
                `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                `&response_type=${responseType}` +
                `&scope=${encodeURIComponent(scope)}` +
                `&nonce=${nonce}`;
            
            console.log('Redirect URI:', redirectUri);
            console.log('Redirecionando para Google OAuth...');
            window.location.href = googleAuthUrl;
        }
        
        // Processar resposta do Google OAuth (quando voltar)
        function handleGoogleCallback() {
            const hash = window.location.hash;
            
            if (hash && hash.includes('id_token')) {
                console.log('Callback do Google detectado!');
                
                // Extrair id_token do hash
                const params = new URLSearchParams(hash.substring(1));
                const idToken = params.get('id_token');
                
                if (idToken) {
                    // Decodificar JWT (parte do payload)
                    try {
                        const payload = JSON.parse(atob(idToken.split('.')[1]));
                        const email = payload.email;
                        const name = payload.name;
                        
                        console.log('Email do Google:', email);
                        
                        // Verificar se o email est√° autorizado
                        if (AUTHORIZED_EMAILS.includes(email)) {
                            const profile = FAMILY_PROFILES[email];
                            
                            const user = {
                                id: profile.id,
                                name: name,
                                email: email,
                                fasting_type: profile.fasting_type,
                                fasting_start: profile.fasting_start,
                                current_weight: 75,
                                goal_weight: 70,
                                avatar_color: '#667eea'
                            };
                            
                            // Salvar usu√°rio
                            window.currentUser = user;
                            localStorage.setItem('fastcarneiro_user', JSON.stringify({
                                email: email,
                                id: profile.id,
                                loginTime: new Date().toISOString()
                            }));
                            
                            // Limpar hash da URL
                            window.history.replaceState(null, null, window.location.pathname);
                            
                            // Mostrar app
                            document.getElementById('loginScreen').classList.add('hidden');
                            document.getElementById('mainApp').classList.remove('hidden');
                            document.getElementById('userGreeting').textContent = `Ol√°, ${name}! üêë`;
                            
                            // Inicializar app
                            setTimeout(() => {
                                if (typeof loadData === 'function') {
                                    loadData();
                                }
                            }, 500);
                            
                            console.log('Login com Google bem-sucedido!');
                        } else {
                            alert('‚ùå Acesso negado!\n\nEste email n√£o est√° autorizado.\nApenas membros da Fam√≠lia Carneiro podem acessar.');
                            window.history.replaceState(null, null, window.location.pathname);
                        }
                    } catch (e) {
                        console.error('Erro ao processar token:', e);
                        alert('‚ùå Erro ao processar login com Google.\n\nTente novamente ou use o modo Demo.');
                    }
                }
            }
        }
        
        // Verificar callback do Google ao carregar
        if (window.location.hash && window.location.hash.includes('id_token')) {
            handleGoogleCallback();
        }
        
        // Fun√ß√£o de entrar no modo Demo
        function enterDemoMode() {
            console.log('Entrando no modo Demo');
            
            const DEMO_USER = {
                id: 'user1',
                name: 'Gon√ßalo',
                email: 'demo@fastcarneiro.app',
                fasting_type: '16:8',
                fasting_start: '20:00',
                current_weight: 75,
                goal_weight: 70,
                avatar_color: '#667eea'
            };
            
            window.currentUser = DEMO_USER;
            
            // Salvar no localStorage
            try {
                localStorage.setItem('fastcarneiro_user', JSON.stringify({
                    email: 'demo',
                    id: 'user1',
                    loginTime: new Date().toISOString()
                }));
            } catch(e) {
                console.error('Erro ao salvar localStorage:', e);
            }
            
            // Esconder login, mostrar app
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            const userGreeting = document.getElementById('userGreeting');
            
            if (loginScreen) loginScreen.classList.add('hidden');
            if (mainApp) mainApp.classList.remove('hidden');
            if (userGreeting) userGreeting.textContent = `Ol√°, ${DEMO_USER.name}! üêë`;
            
            console.log('Modo Demo ativado!');
            
            // Carregar dados iniciais
            setTimeout(() => {
                if (typeof loadData === 'function') {
                    loadData();
                }
                
                // Mostrar notifica√ß√£o moderna (toast)
                showToast('üéâ Bem-vindo ao FastCarneiro!', 'Voc√™ est√° no modo Demo. Explore tudo!');
            }, 500);
        }
        
        // Fun√ß√£o para mostrar toast notification
        function showToast(title, message, type = 'success') {
            const colors = {
                success: 'from-green-500 to-emerald-500',
                info: 'from-purple-500 to-blue-500',
                error: 'from-red-500 to-pink-500',
                warning: 'from-yellow-500 to-orange-500'
            };
            
            const icons = {
                success: 'üéâ',
                info: '‚ÑπÔ∏è',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };
            
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 bg-gradient-to-r ${colors[type]} text-white px-6 py-4 rounded-2xl shadow-2xl z-50 transform transition-all duration-300`;
            toast.style.animation = 'slideInRight 0.3s ease-out';
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="text-3xl">${icons[type]}</div>
                    <div>
                        <div class="font-bold text-lg">${title}</div>
                        <div class="text-sm opacity-90">${message}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Fun√ß√£o de logout
        function logout() {
            console.log('Logout clicado');
            if (!confirm('Tem certeza que deseja sair?')) {
                return;
            }
            
            window.currentUser = null;
            
            try {
                localStorage.removeItem('fastcarneiro_user');
            } catch(e) {
                console.error('Erro ao limpar localStorage:', e);
            }
            
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            if (loginScreen) loginScreen.classList.remove('hidden');
            if (mainApp) mainApp.classList.add('hidden');
            
            console.log('Logout realizado');
        }
        
        // Verificar auto-login quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('FastCarneiro - P√°gina carregada');
            
            // Verificar auto-login
            try {
                const savedUser = localStorage.getItem('fastcarneiro_user');
                if (savedUser) {
                    const userData = JSON.parse(savedUser);
                    const loginTime = new Date(userData.loginTime);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24) {
                        console.log('Auto-login detectado para:', userData.id);
                        
                        // Buscar dados do membro
                        const member = FAMILY_MEMBERS_WITH_PASSWORDS[userData.id];
                        if (member) {
                            // Recriar sess√£o
                            // Tentar carregar configura√ß√µes salvas do localStorage
                            const savedSettings = localStorage.getItem('fastcarneiro_settings_' + member.id);
                            let userSettings = {
                                fasting_type: member.fasting_type,
                                fasting_start: member.fasting_start,
                                current_weight: member.current_weight,
                                goal_weight: member.goal_weight
                            };
                            
                            if (savedSettings) {
                                try {
                                    const parsed = JSON.parse(savedSettings);
                                    userSettings = {
                                        fasting_type: parsed.fasting_type || member.fasting_type,
                                        fasting_start: parsed.fasting_start || member.fasting_start,
                                        current_weight: parsed.current_weight || member.current_weight,
                                        goal_weight: parsed.goal_weight || member.goal_weight
                                    };
                                    console.log('‚úÖ Auto-login: Configura√ß√µes carregadas do localStorage');
                                } catch (e) {
                                    console.error('Erro ao carregar configura√ß√µes salvas:', e);
                                }
                            }
                            
                            window.currentUser = {
                                id: member.id,
                                name: member.name,
                                email: userData.email,
                                fasting_type: userSettings.fasting_type,
                                fasting_start: userSettings.fasting_start,
                                current_weight: userSettings.current_weight,
                                goal_weight: userSettings.goal_weight,
                                avatar_color: member.avatar_color
                            };
                            
                            // Mostrar app
                            setTimeout(() => {
                                document.getElementById('loginScreen').classList.add('hidden');
                                document.getElementById('mainApp').classList.remove('hidden');
                                document.getElementById('userGreeting').textContent = `Ol√°, ${member.name}! ${member.emoji}`;
                                
                                if (typeof initializeApp === 'function') {
                                    initializeApp();
                                } else if (typeof loadData === 'function') {
                                    loadData();
                                }
                                
                                showToast('üëã Bem-vindo de volta!', `Ol√°, ${member.name}!`, 'info');
                            }, 100);
                        }
                    } else {
                        console.log('Auto-login expirado (mais de 24h)');
                        localStorage.removeItem('fastcarneiro_user');
                    }
                } else {
                    console.log('Nenhum auto-login encontrado');
                }
            } catch(e) {
                console.error('Erro no auto-login:', e);
                localStorage.removeItem('fastcarneiro_user');
            }
        });
        
        console.log('Scripts de autentica√ß√£o carregados!');
    </script>
    
    <!-- App JavaScript (Inline para funcionar online) -->
    <script>
// FastCarneiro - App de Jejum Intermitente (GOOGLE SHEETS API)
console.log('üöÄ Carregando FastCarneiro App (Google Sheets)...');

// ========== CONFIGURA√á√ÉO DA API ==========
const API_URL = 'https://script.google.com/macros/s/AKfycbxvJcceThpWPLp84bczUIcvEh6vhCvTHSiR5q9mHAkAAl_YlyqML00gzHPbB7b8Tgs/exec';

// Estado Global da Aplica√ß√£o
if (typeof allUsers === 'undefined') var allUsers = [];
if (typeof checkins === 'undefined') var checkins = [];
if (typeof savings === 'undefined') var savings = [];
if (typeof messages === 'undefined') var messages = [];

// ========== FUN√á√ïES DA API ==========

function generateId() {
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// GET - Ler dados de uma tabela
async function apiGet(table) {
    try {
        const response = await fetch(`${API_URL}?action=read&table=${table}`);
        const data = await response.json();
        return data.data || [];
    } catch (error) {
        console.error(`Erro ao ler ${table}:`, error);
        return [];
    }
}

// POST - Criar novo registro (via GET)
async function apiPost(table, data) {
    try {
        const dataJson = JSON.stringify(data);
        const encodedData = encodeURIComponent(dataJson);
        const response = await fetch(`${API_URL}?action=create&table=${table}&data=${encodedData}`);
        const result = await response.json();
        return result.data || data;
    } catch (error) {
        console.error(`Erro ao criar em ${table}:`, error);
        throw error;
    }
}

// PATCH - Atualizar registro (via GET)
async function apiPatch(table, id, data) {
    try {
        const dataJson = JSON.stringify(data);
        const encodedData = encodeURIComponent(dataJson);
        const response = await fetch(`${API_URL}?action=update&table=${table}&id=${id}&data=${encodedData}`);
        const result = await response.json();
        return result;
    } catch (error) {
        console.error(`Erro ao atualizar em ${table}:`, error);
        throw error;
    }
}

// DELETE - Apagar registro (via GET)
async function apiDelete(table, id) {
    try {
        const response = await fetch(`${API_URL}?action=delete&table=${table}&id=${id}`);
        return true;
    } catch (error) {
        console.error(`Erro ao apagar de ${table}:`, error);
        throw error;
    }
}

// Fun√ß√£o para inicializar app ap√≥s login
async function initializeApp() {
    console.log('‚úÖ initializeApp() chamado!');
    await loadData();
    loadSchedulesTab();
    loadDiaryTab();
    loadRankingsTab();
    loadTreasureTab();
    loadChatTab();
    
    showToast('‚òÅÔ∏è Conectado!', 'Dados sincronizados com a fam√≠lia!', 'success');
}

// Carregamento de Dados do Google Sheets
async function loadData() {
    console.log('‚òÅÔ∏è Carregando dados do Google Sheets...');
    
    try {
        // Carregar users
        allUsers = await apiGet('users');
        
        // Carregar check-ins
        checkins = await apiGet('checkins');
        
        // Carregar savings
        savings = await apiGet('savings');
        
        // Carregar mensagens
        messages = await apiGet('messages');
        
        console.log('‚úÖ Dados carregados do Google Sheets!');
        console.log('üìä Users:', allUsers.length, '| Checkins:', checkins.length, '| Savings:', savings.length, '| Messages:', messages.length);
    } catch (error) {
        console.error('‚ùå Erro ao carregar dados:', error);
        showToast('‚ö†Ô∏è Erro', 'N√£o foi poss√≠vel carregar dados. Verifique a conex√£o.', 'error');
    }
}

// Navega√ß√£o entre tabs
function showTab(tabName) {
    console.log('üìë showTab() chamado para:', tabName);
    
    // Ocultar todas as tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });

    // Remover classe ativa de todos os bot√µes
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('tab-active');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
    });

    // Mostrar tab selecionada
    const tabElement = document.getElementById(tabName + 'Tab');
    if (tabElement) {
        tabElement.classList.remove('hidden');
    } else {
        console.error('ERRO: Tab n√£o encontrada:', tabName + 'Tab');
    }

    // Adicionar classe ativa ao bot√£o
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeBtn) {
        activeBtn.classList.add('tab-active');
        activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
    }

    // Recarregar dados da tab
    switch(tabName) {
        case 'schedules': loadSchedulesTab(); break;
        case 'diary': loadDiaryTab(); break;
        case 'rankings': loadRankingsTab(); break;
        case 'treasure': loadTreasureTab(); break;
        case 'chat': loadChatTab(); break;
    }
    console.log('‚úÖ showTab() conclu√≠do');
}

// Utilidades
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const timeElement = document.getElementById('currentTime');
    if (timeElement) {
        timeElement.textContent = timeString;
    }
}

function formatDate(date) {
    return new Date(date).toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

function getTodayDate() {
    const today = new Date();
    return today.toISOString().split('T')[0];
}

function calculateFastingEnd(startTime, fastingType) {
    const [hours, minutes] = startTime.split(':').map(Number);
    const startDate = new Date();
    startDate.setHours(hours, minutes, 0, 0);
    
    const fastingHours = fastingType === '14:10' ? 14 : 16;
    const endDate = new Date(startDate.getTime() + fastingHours * 60 * 60 * 1000);
    
    return endDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

function isCurrentlyFasting(user) {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const currentTime = currentHour * 60 + currentMinute;

    const [startHour, startMinute] = user.fasting_start.split(':').map(Number);
    const startTime = startHour * 60 + startMinute;

    const fastingHours = user.fasting_type === '14:10' ? 14 : 16;
    let endTime = startTime + (fastingHours * 60);

    if (endTime >= 1440) {
        return currentTime >= startTime || currentTime < (endTime - 1440);
    } else {
        return currentTime >= startTime && currentTime < endTime;
    }
}

// TAB: Hor√°rios da Tribo
function loadSchedulesTab() {
    console.log('Carregando tab Hor√°rios...');
    const statusList = document.getElementById('currentStatusList');
    if (!statusList) return;
    
    statusList.innerHTML = '';

    allUsers.forEach(user => {
        const isFasting = isCurrentlyFasting(user);
        const statusDiv = document.createElement('div');
        statusDiv.className = `flex items-center justify-between p-4 rounded-lg ${isFasting ? 'bg-green-50 border-2 border-green-300' : 'bg-gray-50'}`;
        statusDiv.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg" style="background-color: ${user.avatar_color}">
                    ${user.name.charAt(0)}
                </div>
                <div>
                    <div class="font-semibold text-gray-800">${user.name}</div>
                    <div class="text-sm text-gray-600">${user.fasting_type}</div>
                </div>
            </div>
            <div class="text-right">
                <div class="flex items-center space-x-2">
                    ${isFasting ? 
                        '<span class="text-green-600 font-semibold"><i class="fas fa-check-circle mr-1"></i>Jejuando</span>' : 
                        '<span class="text-gray-500 font-semibold"><i class="fas fa-utensils mr-1"></i>Alimentando</span>'
                    }
                </div>
            </div>
        `;
        statusList.appendChild(statusDiv);
    });

    const schedulesContainer = document.getElementById('familySchedules');
    if (!schedulesContainer) return;
    schedulesContainer.innerHTML = '';

    allUsers.forEach(user => {
        const endTime = calculateFastingEnd(user.fasting_start, user.fasting_type);
        const isFasting = isCurrentlyFasting(user);
        
        const card = document.createElement('div');
        card.className = 'glass-effect rounded-2xl p-6 card-shadow';
        card.innerHTML = `
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-2xl" style="background-color: ${user.avatar_color}">
                    ${user.name.charAt(0)}
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">${user.name}</h3>
                    <span class="inline-block bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-semibold">
                        ${user.fasting_type}
                    </span>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-moon text-blue-600"></i>
                        <span class="text-gray-700 font-medium">In√≠cio</span>
                    </div>
                    <span class="text-xl font-bold text-blue-600">${user.fasting_start}</span>
                </div>

                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-sun text-green-600"></i>
                        <span class="text-gray-700 font-medium">Fim</span>
                    </div>
                    <span class="text-xl font-bold text-green-600">${endTime}</span>
                </div>

                ${user.current_weight ? `
                    <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-weight text-purple-600"></i>
                            <span class="text-gray-700 font-medium">Peso</span>
                        </div>
                        <span class="text-xl font-bold text-purple-600">${user.current_weight} kg</span>
                    </div>
                ` : ''}

                <div class="mt-4 p-4 ${isFasting ? 'bg-green-100 border-2 border-green-400' : 'bg-gray-100'} rounded-lg text-center">
                    <p class="font-semibold ${isFasting ? 'text-green-700' : 'text-gray-600'}">
                        ${isFasting ? 'üî• Jejuando agora!' : 'üçΩÔ∏è Janela alimentar'}
                    </p>
                </div>
            </div>
        `;
        schedulesContainer.appendChild(card);
    });
}

// TAB: Meu Di√°rio
function loadDiaryTab() {
    console.log('Carregando tab Di√°rio...');
    const today = new Date();
    const todayDateEl = document.getElementById('todayDate');
    if (todayDateEl) {
        todayDateEl.textContent = today.toLocaleDateString('pt-BR', {
            weekday: 'long',
            day: 'numeric',
            month: 'long'
        });
    }

    if (window.currentUser) {
        const userCheckins = checkins.filter(c => c.user_id === window.currentUser.id);
        const successfulCheckins = userCheckins.filter(c => c.success);
        
        let streak = 0;
        const sortedCheckins = [...userCheckins].sort((a, b) => 
            new Date(b.date) - new Date(a.date)
        );
        
        for (let i = 0; i < sortedCheckins.length; i++) {
            if (sortedCheckins[i].success) {
                streak++;
            } else {
                break;
            }
        }

        const streakEl = document.getElementById('streakDays');
        const successEl = document.getElementById('successDays');
        const rateEl = document.getElementById('successRate');
        
        if (streakEl) streakEl.textContent = streak;
        if (successEl) successEl.textContent = successfulCheckins.length;
        
        const successRate = userCheckins.length > 0 
            ? Math.round((successfulCheckins.length / userCheckins.length) * 100)
            : 0;
        if (rateEl) rateEl.textContent = successRate + '%';

        loadHistory();
    }
}

function loadHistory() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    historyList.innerHTML = '';

    if (!window.currentUser) return;

    const userCheckins = checkins
        .filter(c => c.user_id === window.currentUser.id)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 10);

    if (userCheckins.length === 0) {
        historyList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum registro ainda</p>';
        return;
    }

    userCheckins.forEach(checkin => {
        const div = document.createElement('div');
        div.className = `flex items-center justify-between p-3 rounded-lg ${checkin.success ? 'bg-green-50' : 'bg-red-50'}`;
        div.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="text-2xl">${checkin.success ? '‚úÖ' : '‚ùå'}</div>
                <div>
                    <div class="font-semibold text-gray-800">${formatDate(checkin.date)}</div>
                    ${checkin.weight ? `<div class="text-sm text-gray-600">Peso: ${checkin.weight} kg</div>` : ''}
                </div>
            </div>
            <div class="text-sm font-semibold ${checkin.success ? 'text-green-600' : 'text-red-600'}">
                ${checkin.success ? 'Sucesso' : 'N√£o completado'}
            </div>
        `;
        historyList.appendChild(div);
    });
}

async function checkIn(result) {
    if (!window.currentUser) return;

    const today = getTodayDate();
    const existingCheckin = checkins.find(c => 
        c.user_id === window.currentUser.id && c.date === today
    );

    if (existingCheckin) {
        alert('Voc√™ j√° fez o check-in hoje!');
        return;
    }

    const success = result === 'yes';
    
    try {
        // Criar novo check-in
        const newCheckin = {
            id: generateId(),
            user_id: window.currentUser.id,
            date: today,
            success: success,
            notes: '',
            created_at: new Date().toISOString()
        };
        
        await apiPost('checkins', newCheckin);
        checkins.push(newCheckin);

        // Se teve sucesso, adicionar 1‚Ç¨ ao tesouro
        if (success) {
            const newSaving = {
                id: generateId(),
                user_id: window.currentUser.id,
                date: today,
                amount: 1,
                created_at: new Date().toISOString()
            };
            await apiPost('savings', newSaving);
            savings.push(newSaving);
        }

        showToast(
            success ? 'üéâ Parab√©ns!' : 'üí™ N√£o desista!',
            success ? 'Check-in realizado! +1‚Ç¨ para o tesouro!' : 'Amanh√£ √© um novo dia!',
            success ? 'success' : 'warning'
        );
        
        loadDiaryTab();
        loadTreasureTab();
    } catch (error) {
        console.error('Erro ao fazer check-in:', error);
        showToast('‚ùå Erro', 'N√£o foi poss√≠vel salvar o check-in.', 'error');
    }
}

async function saveWeight() {
    if (!window.currentUser) return;

    const weight = parseFloat(document.getElementById('weightInput').value);
    if (!weight || weight <= 0) {
        alert('Por favor, insira um peso v√°lido!');
        return;
    }

    const today = getTodayDate();
    const existingCheckin = checkins.find(c => 
        c.user_id === window.currentUser.id && c.date === today
    );

    try {
        if (existingCheckin) {
            // Actualizar check-in existente
            await apiPatch('checkins', existingCheckin.id, {weight: weight});
            existingCheckin.weight = weight;
        } else {
            // Criar novo check-in s√≥ com peso
            const newCheckin = {
                id: generateId(),
                user_id: window.currentUser.id,
                date: today,
                success: false,
                weight: weight,
                notes: '',
                created_at: new Date().toISOString()
            };
            await apiPost('checkins', newCheckin);
            checkins.push(newCheckin);
        }

        // Actualizar peso do usu√°rio
        const userIndex = allUsers.findIndex(u => u.id === window.currentUser.id);
        if (userIndex !== -1) {
            await apiPatch('users', window.currentUser.id, {current_weight: weight});
            allUsers[userIndex].current_weight = weight;
        }

        window.currentUser.current_weight = weight;
        document.getElementById('weightInput').value = '';
        
        showToast('‚úÖ Peso Registrado!', `Seu peso atual: ${weight} kg`, 'success');
        
        loadDiaryTab();
        loadSchedulesTab();
    } catch (error) {
        console.error('Erro ao salvar peso:', error);
        showToast('‚ùå Erro', 'N√£o foi poss√≠vel salvar o peso.', 'error');
    }
}

async function deleteMyHistory() {
    if (!window.currentUser) return;
    
    const confirmFirst = confirm('‚ö†Ô∏è TEM CERTEZA?\n\nVoc√™ est√° prestes a APAGAR TODO o seu hist√≥rico de jejum!\n\nIsso inclui:\n- Todos os check-ins\n- Todo o hist√≥rico de peso\n- Todas as economias registradas\n\nEsta a√ß√£o N√ÉO PODE SER DESFEITA!\n\nDeseja continuar?');
    
    if (!confirmFirst) return;
    
    const confirmSecond = confirm('üö® √öLTIMA CONFIRMA√á√ÉO!\n\nDigite seu nome para confirmar: ' + window.currentUser.name);
    
    if (!confirmSecond) return;
    
    try {
        console.log('üóëÔ∏è Apagando hist√≥rico do usu√°rio:', window.currentUser.id);
        
        // Apagar check-ins
        const userCheckins = checkins.filter(c => c.user_id === window.currentUser.id);
        for (const checkin of userCheckins) {
            await apiDelete('checkins', checkin.id);
        }
        
        // Apagar savings
        const userSavings = savings.filter(s => s.user_id === window.currentUser.id);
        for (const saving of userSavings) {
            await apiDelete('savings', saving.id);
        }
        
        // Remover dos arrays locais
        checkins = checkins.filter(c => c.user_id !== window.currentUser.id);
        savings = savings.filter(s => s.user_id !== window.currentUser.id);
        
        showToast('‚úÖ Hist√≥rico Apagado!', 'Voc√™ pode come√ßar do zero agora. Boa sorte! üí™', 'success');
        
        loadDiaryTab();
        loadTreasureTab();
    } catch (error) {
        console.error('Erro ao apagar hist√≥rico:', error);
        showToast('‚ùå Erro', 'N√£o foi poss√≠vel apagar o hist√≥rico.', 'error');
    }
}

// TAB: Rankings
function loadRankingsTab() {
    console.log('Carregando tab Rankings...');
    const scores = allUsers.map(user => {
        const userCheckins = checkins.filter(c => c.user_id === user.id);
        const successCount = userCheckins.filter(c => c.success).length;
        const totalDays = userCheckins.length;
        const successRate = totalDays > 0 ? (successCount / totalDays) * 100 : 0;

        let streak = 0;
        const sortedCheckins = [...userCheckins].sort((a, b) => 
            new Date(b.date) - new Date(a.date)
        );
        for (let i = 0; i < sortedCheckins.length; i++) {
            if (sortedCheckins[i].success) streak++;
            else break;
        }

        return {
            user,
            successCount,
            totalDays,
            successRate,
            streak,
            score: successCount * 10 + streak * 5
        };
    }).sort((a, b) => b.score - a.score);

    const leaderboard = document.getElementById('leaderboard');
    if (!leaderboard) return;
    leaderboard.innerHTML = '';

    scores.forEach((item, index) => {
        const div = document.createElement('div');
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∫`;
        
        div.className = `flex items-center justify-between p-4 rounded-xl ${
            index === 0 ? 'bg-gradient-to-r from-yellow-100 to-yellow-200 border-2 border-yellow-400' :
            index === 1 ? 'bg-gradient-to-r from-gray-100 to-gray-200 border-2 border-gray-400' :
            index === 2 ? 'bg-gradient-to-r from-orange-100 to-orange-200 border-2 border-orange-400' :
            'bg-gray-50'
        }`;
        
        div.innerHTML = `
            <div class="flex items-center space-x-4">
                <div class="text-3xl font-bold">${medal}</div>
                <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold" style="background-color: ${item.user.avatar_color}">
                    ${item.user.name.charAt(0)}
                </div>
                <div>
                    <div class="font-bold text-gray-800">${item.user.name}</div>
                    <div class="text-sm text-gray-600">
                        ${item.successCount} sucessos ‚Ä¢ ${item.streak} dias seguidos
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold text-purple-600">${item.score}</div>
                <div class="text-sm text-gray-600">pontos</div>
            </div>
        `;
        leaderboard.appendChild(div);
    });

    loadAchievements(scores);
}

function loadAchievements(scores) {
    const achievements = [
        { id: 'survivor', title: 'Sobrevivente da Geladeira', desc: '1 semana completa', icon: 'üèîÔ∏è', requirement: 7, benefit: 'Melhoria na regula√ß√£o da insulina' },
        { id: 'master', title: 'Mestre do Autocontrole', desc: '1 m√™s completo', icon: 'üßò', requirement: 30, benefit: 'Redu√ß√£o da inflama√ß√£o corporal' },
        { id: 'ninja', title: 'Ninja da Disciplina', desc: '3 meses completos', icon: 'ü•∑', requirement: 90, benefit: 'Melhoria da fun√ß√£o cerebral' },
        { id: 'legend', title: 'Lenda da Fam√≠lia', desc: '6 meses completos', icon: 'üëë', requirement: 180, benefit: 'Aumento da longevidade' },
        { id: 'forreta', title: 'Resistiu ao Pai Forreta', desc: '15 dias seguidos', icon: 'üí∞', requirement: 15, benefit: 'For√ßa de vontade de a√ßo' },
        { id: 'beata', title: 'Santo Jejum da Beata', desc: '21 dias seguidos', icon: 'üôè', requirement: 21, benefit: 'B√™n√ß√£o divina confirmada' }
    ];

    const achievementsList = document.getElementById('achievementsList');
    if (!achievementsList) return;
    achievementsList.innerHTML = '';

    achievements.forEach(achievement => {
        const userAchievement = window.currentUser ? scores.find(s => s.user.id === window.currentUser.id) : null;
        const isUnlocked = userAchievement && 
            (achievement.id.includes('legend') ? userAchievement.successCount >= achievement.requirement :
             userAchievement.streak >= achievement.requirement);

        const div = document.createElement('div');
        div.className = `p-4 rounded-xl border-2 ${
            isUnlocked 
                ? 'bg-gradient-to-br from-purple-100 to-blue-100 border-purple-400 badge-glow' 
                : 'bg-gray-100 border-gray-300 opacity-50'
        }`;
        
        div.innerHTML = `
            <div class="flex items-center space-x-3 mb-2">
                <div class="text-3xl">${achievement.icon}</div>
                <div class="flex-1">
                    <div class="font-bold text-gray-800">${achievement.title}</div>
                    <div class="text-sm text-gray-600">${achievement.desc}</div>
                </div>
                ${isUnlocked ? '<div class="text-2xl">‚úÖ</div>' : '<div class="text-2xl">üîí</div>'}
            </div>
            <div class="text-xs text-purple-700 font-medium mt-2">
                üíä ${achievement.benefit}
            </div>
        `;
        achievementsList.appendChild(div);
    });
}

// TAB: Tesouro
function loadTreasureTab() {
    console.log('Carregando tab Tesouro...');
    const total = savings.reduce((sum, s) => sum + (s.amount || 0), 0);
    const totalEl = document.getElementById('totalSavings');
    if (totalEl) totalEl.textContent = `${total}‚Ç¨`;

    const individualDiv = document.getElementById('individualSavings');
    if (!individualDiv) return;
    individualDiv.innerHTML = '';

    allUsers.forEach(user => {
        const userSavings = savings
            .filter(s => s.user_id === user.id)
            .reduce((sum, s) => sum + (s.amount || 0), 0);
        
        const percentage = total > 0 ? Math.round((userSavings / total) * 100) : 0;

        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-4 bg-purple-50 rounded-xl';
        div.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background-color: ${user.avatar_color}">
                    ${user.name.charAt(0)}
                </div>
                <div>
                    <div class="font-semibold text-gray-800">${user.name}</div>
                    <div class="text-sm text-gray-600">${percentage}% do total</div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold text-purple-600">${userSavings}‚Ç¨</div>
            </div>
        `;
        individualDiv.appendChild(div);
    });
}

function calculateTrip() {
    const goal = parseFloat(document.getElementById('tripGoal').value);
    if (!goal || goal <= 0) {
        alert('Por favor, insira uma meta v√°lida!');
        return;
    }

    const total = savings.reduce((sum, s) => sum + (s.amount || 0), 0);
    const remaining = goal - total;
    const percentage = Math.round((total / goal) * 100);

    const daysNeeded = Math.ceil(remaining / 4);
    const weeksNeeded = Math.ceil(daysNeeded / 7);

    const resultDiv = document.getElementById('tripResult');
    if (!resultDiv) return;
    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = `
        <h4 class="font-bold text-gray-800 mb-3">üìä An√°lise da Viagem</h4>
        <div class="space-y-2 text-gray-700">
            <p><strong>Meta:</strong> ${goal}‚Ç¨</p>
            <p><strong>Acumulado:</strong> ${total}‚Ç¨ (${percentage}%)</p>
            <p><strong>Faltam:</strong> ${remaining > 0 ? remaining + '‚Ç¨' : 'Meta alcan√ßada! üéâ'}</p>
            ${remaining > 0 ? `
                <p><strong>Tempo estimado:</strong> ${daysNeeded} dias (‚âà${weeksNeeded} semanas)</p>
                <p class="text-sm text-purple-600 mt-2">üí° Se todos jejuarem todos os dias!</p>
            ` : ''}
        </div>
        <div class="mt-4 bg-white rounded-lg p-3">
            <div class="flex justify-between text-sm mb-1">
                <span>Progresso</span>
                <span>${percentage}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-4 rounded-full transition-all duration-500" style="width: ${Math.min(percentage, 100)}%"></div>
            </div>
        </div>
    `;
}

async function deleteMySavings() {
    if (!window.currentUser) return;
    
    const userSavings = savings.filter(s => s.user_id === window.currentUser.id);
    const totalUserSavings = userSavings.reduce((sum, s) => sum + (s.amount || 0), 0);
    
    if (totalUserSavings === 0) {
        alert('‚ÑπÔ∏è Voc√™ ainda n√£o tem economias registradas no tesouro!');
        return;
    }
    
    const confirmFirst = confirm(`‚ö†Ô∏è TEM CERTEZA?\n\nVoc√™ est√° prestes a CANCELAR todas as suas economias!\n\nValor total: ${totalUserSavings}‚Ç¨\n\nIsso vai:\n- Remover todas as suas contribui√ß√µes\n- Diminuir o tesouro total da fam√≠lia\n- N√£o pode ser desfeito!\n\nOs outros membros N√ÉO ser√£o afetados.\n\nDeseja continuar?`);
    
    if (!confirmFirst) return;
    
    const confirmSecond = confirm(`üö® √öLTIMA CONFIRMA√á√ÉO!\n\nVoc√™ vai perder ${totalUserSavings}‚Ç¨ do tesouro!\n\nDigite seu nome para confirmar: ` + window.currentUser.name);
    
    if (!confirmSecond) return;
    
    try {
        console.log('üí∏ Apagando economias do usu√°rio:', window.currentUser.id);
        
        // Apagar do Google Sheets
        for (const saving of userSavings) {
            await apiDelete('savings', saving.id);
        }
        
        // Remover dos arrays locais
        savings = savings.filter(s => s.user_id !== window.currentUser.id);
        
        showToast('‚úÖ Economias Canceladas!', `${totalUserSavings}‚Ç¨ foram removidos do tesouro. Os outros membros n√£o foram afetados.`, 'success');
        
        loadTreasureTab();
        loadDiaryTab();
    } catch (error) {
        console.error('Erro ao cancelar economias:', error);
        showToast('‚ùå Erro', 'N√£o foi poss√≠vel cancelar as economias.', 'error');
    }
}

// TAB: Chat
function loadChatTab() {
    console.log('Carregando tab Chat...');
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    chatMessages.innerHTML = '';

    if (messages.length === 0) {
        chatMessages.innerHTML = '<p class="text-gray-500 text-center">Nenhuma mensagem ainda. Seja o primeiro a enviar!</p>';
        return;
    }

    messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    messages.forEach(msg => {
        const isCurrentUser = window.currentUser && msg.user_id === window.currentUser.id;
        const div = document.createElement('div');
        div.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
        
        div.innerHTML = `
            <div class="max-w-xs lg:max-w-md">
                ${!isCurrentUser ? `<div class="text-xs text-gray-600 mb-1 ml-2">${msg.user_name}</div>` : ''}
                <div class="p-3 rounded-lg ${
                    isCurrentUser 
                        ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white' 
                        : 'bg-white border border-gray-200 text-gray-800'
                }">
                    ${msg.message}
                </div>
                <div class="text-xs text-gray-500 mt-1 ${isCurrentUser ? 'text-right' : 'text-left'} mx-2">
                    ${new Date(msg.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                </div>
            </div>
        `;
        chatMessages.appendChild(div);
    });

    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendMessage() {
    if (!window.currentUser) return;

    const input = document.getElementById('chatInput');
    const message = input.value.trim();

    if (!message) return;

    try {
        const newMessage = {
            id: generateId(),
            user_id: window.currentUser.id,
            user_name: window.currentUser.name,
            message: message,
            timestamp: new Date().toISOString()
        };
        
        await apiPost('messages', newMessage);
        messages.push(newMessage);
        
        input.value = '';
        loadChatTab();
    } catch (error) {
        console.error('Erro ao enviar mensagem:', error);
        showToast('‚ùå Erro', 'N√£o foi poss√≠vel enviar a mensagem.', 'error');
    }
}

function sendQuickMessage(message) {
    document.getElementById('chatInput').value = message;
    sendMessage();
}

// Modal de Configura√ß√£o
function openScheduleModal() {
    const modal = document.getElementById('scheduleModal');
    if (!modal) return;
    modal.classList.remove('hidden');
    
    if (window.currentUser) {
        const startInput = document.getElementById('fastingStart');
        const weightInput = document.getElementById('currentWeight');
        const goalInput = document.getElementById('goalWeight');
        
        if (startInput) startInput.value = window.currentUser.fasting_start;
        if (weightInput) weightInput.value = window.currentUser.current_weight || '';
        if (goalInput) goalInput.value = window.currentUser.goal_weight || '';
        selectFastingType(window.currentUser.fasting_type);
    }
}

function closeScheduleModal() {
    const modal = document.getElementById('scheduleModal');
    if (modal) modal.classList.add('hidden');
}

function selectFastingType(type) {
    document.querySelectorAll('.fasting-type-btn').forEach(btn => {
        if (btn.dataset.type === type) {
            btn.classList.add('border-purple-500', 'bg-purple-50', 'text-purple-700');
            btn.classList.remove('border-gray-300');
        } else {
            btn.classList.remove('border-purple-500', 'bg-purple-50', 'text-purple-700');
            btn.classList.add('border-gray-300');
        }
    });
}

async function saveSchedule() {
    if (!window.currentUser) return;

    const fastingType = document.querySelector('.fasting-type-btn.border-purple-500')?.dataset.type;
    const fastingStart = document.getElementById('fastingStart')?.value;
    const currentWeight = parseFloat(document.getElementById('currentWeight')?.value);
    const goalWeight = parseFloat(document.getElementById('goalWeight')?.value);

    if (!fastingStart) {
        alert('Por favor, selecione a hora de in√≠cio do jejum!');
        return;
    }

    try {
        const updateData = {
            fasting_start: fastingStart
        };
        if (fastingType) updateData.fasting_type = fastingType;
        if (currentWeight) updateData.current_weight = currentWeight;
        if (goalWeight) updateData.goal_weight = goalWeight;

        // Actualizar no Google Sheets
        await apiPatch('users', window.currentUser.id, updateData);

        // Actualizar localmente
        const userIndex = allUsers.findIndex(u => u.id === window.currentUser.id);
        if (userIndex !== -1) {
            if (fastingType) allUsers[userIndex].fasting_type = fastingType;
            allUsers[userIndex].fasting_start = fastingStart;
            if (currentWeight) allUsers[userIndex].current_weight = currentWeight;
            if (goalWeight) allUsers[userIndex].goal_weight = goalWeight;
        }

        // Actualizar currentUser
        if (fastingType) window.currentUser.fasting_type = fastingType;
        window.currentUser.fasting_start = fastingStart;
        if (currentWeight) window.currentUser.current_weight = currentWeight;
        if (goalWeight) window.currentUser.goal_weight = goalWeight;

        // Salvar configura√ß√µes localmente tamb√©m (para auto-login)
        const userSettings = {
            userId: window.currentUser.id,
            fasting_type: window.currentUser.fasting_type,
            fasting_start: fastingStart,
            current_weight: currentWeight || window.currentUser.current_weight,
            goal_weight: goalWeight || window.currentUser.goal_weight
        };
        localStorage.setItem('fastcarneiro_settings_' + window.currentUser.id, JSON.stringify(userSettings));

        showToast('‚úÖ Configura√ß√µes Salvas!', 'Seu jejum foi configurado com sucesso!', 'success');
        
        closeScheduleModal();
        await loadData();
        loadSchedulesTab();
    } catch (error) {
        console.error('Erro ao salvar configura√ß√µes:', error);
        showToast('‚ùå Erro', 'N√£o foi poss√≠vel salvar as configura√ß√µes.', 'error');
    }
}

// Iniciar rel√≥gio
updateCurrentTime();
setInterval(updateCurrentTime, 1000);

console.log('‚úÖ FastCarneiro App carregado (Inline Version)!');
console.log('‚úÖ showTab:', typeof showTab);
console.log('‚úÖ initializeApp:', typeof initializeApp);
console.log('‚úÖ loadData:', typeof loadData);
    </script>
</body>
</html>
